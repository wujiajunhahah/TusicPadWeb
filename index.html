<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TusicPadWeb — Pencil ▶︎ Strudel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Space+Grotesk:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root{
    color-scheme:dark;
    --bg:#0b0b0c;
    --grid:#15161a;
    --stroke:#25262c;
    --stroke-strong:#3a3b44;
    --accent:#ff3b45;
    --accent-soft:rgba(255,59,69,0.18);
    --text:#f4f5f7;
    --muted:rgba(244,245,247,0.55);
  }
  *,*::before,*::after{box-sizing:border-box;}
  html,body{margin:0;min-height:100%;}
  body{
    font-family:'Space Grotesk','SF Pro Display',system-ui,-apple-system,'Segoe UI',sans-serif;
    background-color:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    -webkit-font-smoothing:antialiased;
    touch-action:manipulation;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background-image:radial-gradient(var(--grid) 1px, transparent 0);
    background-size:10px 10px;
    opacity:0.85;
    pointer-events:none;
    z-index:-2;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,0.72) 0%, transparent 38%, transparent 72%, rgba(0,0,0,0.82) 100%);
    pointer-events:none;
    z-index:-1;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:28px clamp(20px,5vw,52px) 18px;
    border-bottom:1px solid var(--stroke);
    text-transform:uppercase;
    letter-spacing:0.22em;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:18px;
  }
  .glyph{
    width:54px;
    height:54px;
    border-radius:50%;
    border:1px solid var(--stroke-strong);
    display:grid;
    place-items:center;
    font-family:'DotGothic16','Space Grotesk',monospace;
    font-size:20px;
    letter-spacing:0.28em;
    position:relative;
  }
  .glyph::after{
    content:"";
    position:absolute;
    inset:12px;
    border:1px dashed var(--stroke-strong);
    border-radius:50%;
  }
  .brand-text{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .brand-text span{
    font-family:'DotGothic16','Space Grotesk',monospace;
    font-size:clamp(18px,3.4vw,26px);
  }
  .brand-text em{
    font-style:normal;
    font-size:12px;
    letter-spacing:0.42em;
    color:var(--muted);
  }
  .actions{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  button{
    appearance:none;
    border:1px solid var(--stroke);
    background:transparent;
    color:var(--text);
    cursor:pointer;
    border-radius:999px;
    text-transform:uppercase;
    letter-spacing:0.18em;
    font-size:12px;
    padding:10px 18px;
    transition:border-color 0.25s ease, color 0.25s ease, background 0.25s ease;
  }
  button:hover{border-color:var(--accent); color:var(--accent);}
  button:focus-visible{outline:2px dashed var(--accent); outline-offset:4px;}
  #status-pill{
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 18px;
    border-radius:999px;
    border:1px dashed var(--stroke);
    font-size:12px;
    letter-spacing:0.18em;
  }
  #status-pill .dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background:var(--stroke);
    transition:background 0.25s ease, box-shadow 0.25s ease;
  }
  #status-pill[data-state="ready"]{border-color:var(--accent); color:var(--accent);}
  #status-pill[data-state="ready"] .dot{background:var(--accent); box-shadow:0 0 6px rgba(255,59,69,0.6);}
  #status-pill[data-state="live"]{border-color:var(--accent); background:var(--accent-soft); color:var(--accent);}
  #status-pill[data-state="live"] .dot{background:var(--accent); box-shadow:0 0 12px rgba(255,59,69,0.6);}
  main{
    flex:1;
    display:grid;
    grid-template-rows:minmax(320px, 58vh) minmax(240px, 1fr);
    gap:clamp(16px,4vw,28px);
    padding:24px clamp(20px,6vw,52px) clamp(26px,6vw,52px);
  }
  .surface{
    position:relative;
    border-radius:24px;
    border:1px solid var(--stroke);
    background:rgba(12,12,14,0.78);
    overflow:hidden;
  }
  #pad{
    touch-action:none;
  }
  #pad::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(transparent 79%, rgba(255,255,255,0.04) 79%, rgba(255,255,255,0.04) 81%, transparent 81%),
      linear-gradient(90deg, transparent 79%, rgba(255,255,255,0.04) 79%, rgba(255,255,255,0.04) 81%, transparent 81%);
    background-size:92px 92px;
    pointer-events:none;
    mix-blend-mode:screen;
    opacity:0.4;
    transition:opacity 0.35s ease;
  }
  #pad.is-active::before{opacity:0.75;}
  canvas{width:100%;height:100%;display:block;background:radial-gradient(circle at 50% 50%, rgba(255,59,69,0.08), transparent 65%), rgba(6,6,7,0.9);}
  .hud{
    position:absolute;
    top:28px;
    left:28px;
    display:grid;
    gap:8px;
    padding:18px 22px;
    background:rgba(11,11,12,0.72);
    border:1px solid var(--stroke);
    border-radius:16px;
    pointer-events:none;
    text-transform:uppercase;
    letter-spacing:0.18em;
    font-size:11px;
  }
  .hud strong{
    font-family:'DotGothic16','Space Grotesk',monospace;
    font-size:14px;
    letter-spacing:0.3em;
  }
  .hud span{color:var(--muted);}
  .hud .tips{display:flex;flex-wrap:wrap;gap:8px;}
  .hud .tips span{
    border:1px dashed var(--stroke);
    border-radius:999px;
    padding:6px 12px;
  }
  .embed iframe{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
  }
  .frame-label{
    position:absolute;
    top:24px;
    left:24px;
    padding:8px 14px;
    border-radius:14px;
    border:1px dashed var(--stroke);
    background:rgba(11,11,12,0.72);
    text-transform:uppercase;
    letter-spacing:0.26em;
    font-size:11px;
    color:var(--muted);
    pointer-events:none;
  }
  #gate{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    background:rgba(7,7,8,0.9);
    border-top:1px solid var(--stroke);
    border-bottom:1px solid var(--stroke);
    z-index:20;
  }
  #gate[hidden]{display:none;}
  .gate-card{
    max-width:420px;
    width:100%;
    padding:36px clamp(24px,6vw,44px);
    border:1px dashed var(--stroke);
    border-radius:24px;
    background:rgba(9,9,10,0.82);
    text-align:center;
    text-transform:uppercase;
    letter-spacing:0.24em;
    display:grid;
    gap:18px;
  }
  .gate-card h2{margin:0;font-family:'DotGothic16','Space Grotesk',monospace;font-size:18px;}
  .gate-card p{margin:0;color:var(--muted);font-size:12px;}
  .primary{
    background:var(--accent);
    color:#0a0a0b;
    border-color:var(--accent);
  }
  .primary:hover{background:transparent;color:var(--accent);}
  @media (max-width:880px){
    header{flex-direction:column;align-items:flex-start;gap:16px;padding-top:24px;}
    .actions{width:100%;justify-content:flex-start;}
    main{grid-template-rows:minmax(300px, 48vh) minmax(240px, 1fr);}
    .hud{top:20px;left:20px;padding:16px 18px;}
  }
  @media (max-width:620px){
    header{letter-spacing:0.18em;}
    button{font-size:11px;letter-spacing:0.14em;padding:9px 16px;}
    .hud{letter-spacing:0.14em;}
    .frame-label{letter-spacing:0.18em;}
  }
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important;}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="glyph" aria-hidden="true">TP</div>
    <div class="brand-text">
      <span>TusicPadWeb</span>
      <em>Pencil → Strudel Shell</em>
    </div>
  </div>
  <div class="actions">
    <button id="clear" type="button">Clear Canvas</button>
    <span id="status-pill" data-state="waiting">
      <span class="dot" aria-hidden="true"></span>
      <span id="status-text">Waiting</span>
    </span>
  </div>
</header>

<main>
  <section id="pad" class="surface" aria-label="Pencil 捕获区域">
    <canvas id="cv"></canvas>
    <div class="hud">
      <strong>Draw to Play</strong>
      <span>Apple Pencil 数据将实时送入 Strudel。</span>
      <div class="tips">
        <span>X → Rhythm Density</span>
        <span>Y → Pitch</span>
        <span>Pressure → Gain</span>
      </div>
    </div>
  </section>
  <section class="surface embed" aria-label="Strudel REPL">
    <iframe id="strudel" src="https://strudel.cc/repl" allow="autoplay; clipboard-read; clipboard-write" title="Strudel REPL"></iframe>
    <div class="frame-label">Strudel Repl · Paste Receiver & Run</div>
  </section>
</main>

<div id="gate" role="dialog" aria-modal="true">
  <div class="gate-card">
    <h2>Initialize the Session</h2>
    <p>点击开始，随后在 Strudel 中粘贴接收片段并点一次 Run 以解锁音频。</p>
    <button id="open" class="primary" type="button">Start</button>
  </div>
</div>

<script>
const pad = document.getElementById('pad');
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const strudelFrame = document.getElementById('strudel');
const statusPill = document.getElementById('status-pill');
const statusText = document.getElementById('status-text');
const clearButton = document.getElementById('clear');
const gate = document.getElementById('gate');
const openButton = document.getElementById('open');

const statusCopy = {
  waiting: 'Waiting',
  ready: 'Ready',
  live: 'Live'
};

const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
let fadeHandle = null;
let hue = 0;
let lastSent = 0;
let settleTimer;

function setStatus(state){
  statusPill.dataset.state = state;
  statusText.textContent = statusCopy[state] || '';
}

function resizeCanvas(){
  const rect = pad.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const width = Math.max(1, Math.floor(rect.width * dpr));
  const height = Math.max(1, Math.floor(rect.height * dpr));
  if(canvas.width !== width || canvas.height !== height){
    canvas.width = width;
    canvas.height = height;
  }
}

function clearCanvas(){
  ctx.save();
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'rgba(7,7,8,1)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();
  hue = 0;
}

function fadeFrame(){
  ctx.fillStyle = 'rgba(8,8,10,0.18)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  fadeHandle = requestAnimationFrame(fadeFrame);
}

function drawDot(x, y, pressure){
  const radius = (7 + pressure * 14) * (window.devicePixelRatio || 1);
  ctx.fillStyle = `hsla(${(hue % 360).toFixed(2)}, 80%, 64%, ${0.32 + pressure * 0.46})`;
  ctx.beginPath();
  ctx.arc(x * canvas.width, y * canvas.height, radius, 0, Math.PI * 2);
  ctx.fill();
  hue += 2.2;
}

function sendPen(x, y, pressure){
  const target = strudelFrame.contentWindow;
  if(!target) return;
  target.postMessage({ type: 'pen', x, y, pressure, t: performance.now() }, '*');
}

function updateInteractionState(){
  pad.classList.add('is-active');
  setStatus('live');
  clearTimeout(settleTimer);
  settleTimer = setTimeout(() => {
    pad.classList.remove('is-active');
    setStatus('ready');
  }, 1000);
}

function pointerToCanvas(event){
  const rect = canvas.getBoundingClientRect();
  const x = (event.clientX - rect.left) / rect.width;
  const y = (event.clientY - rect.top) / rect.height;
  const pressure = typeof event.pressure === 'number' ? event.pressure : 0.35;
  return {
    x: Math.min(1, Math.max(0, x)),
    y: Math.min(1, Math.max(0, y)),
    pressure: Math.min(1, Math.max(0, pressure))
  };
}

pad.addEventListener('pointerdown', event => {
  if(event.pointerType !== 'pen') return;
  const data = pointerToCanvas(event);
  drawDot(data.x, data.y, data.pressure);
  sendPen(data.x, data.y, data.pressure);
  updateInteractionState();
});

pad.addEventListener('pointermove', event => {
  if(event.pointerType !== 'pen' || event.buttons === 0) return;
  const data = pointerToCanvas(event);
  drawDot(data.x, data.y, data.pressure);
  const now = performance.now();
  if(now - lastSent > 16){
    sendPen(data.x, data.y, data.pressure);
    lastSent = now;
  }
  updateInteractionState();
}, { passive: true });

pad.addEventListener('pointerup', () => {
  clearTimeout(settleTimer);
  settleTimer = setTimeout(() => {
    pad.classList.remove('is-active');
    setStatus('ready');
  }, 600);
});

pad.addEventListener('pointerleave', () => {
  clearTimeout(settleTimer);
  pad.classList.remove('is-active');
  settleTimer = setTimeout(() => setStatus('ready'), 600);
});

clearButton.addEventListener('click', () => {
  clearCanvas();
  pad.classList.remove('is-active');
  setStatus('ready');
});

openButton.addEventListener('click', () => {
  gate.setAttribute('hidden', 'true');
  setStatus('ready');
  const target = strudelFrame.contentWindow;
  if(target){
    target.postMessage({ type: 'hint', action: 'focus' }, '*');
  }
});

window.addEventListener('resize', resizeCanvas, { passive: true });
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 260));

resizeCanvas();
clearCanvas();
if(!reduceMotion){
  fadeHandle = requestAnimationFrame(fadeFrame);
}

window.addEventListener('beforeunload', () => {
  if(fadeHandle){
    cancelAnimationFrame(fadeHandle);
  }
});

</script>
</body>
</html>
