<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TusicPadWeb — Pencil ▶︎ Strudel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@400;500;600&family=Recursive:wght@400;500&family=Space+Grotesk:wght@400;500;600&family=VT323&display=swap" rel="stylesheet">
<style>
  :root{
    color-scheme:dark;
    --bg:#050505;
    --grid:#0f0f10;
    --panel:#0b0b0d;
    --panel-alt:#101012;
    --border:#1b1b1f;
    --border-strong:#2d2d33;
    --accent:#ff004f;
    --accent-alt:#ff7a00;
    --accent-faint:rgba(255,0,79,0.18);
    --text:#f5f6f7;
    --muted:rgba(243,244,246,0.58);
    --font-display:'DotGothic16','VT323','Recursive','Space Grotesk',monospace;
    --font-ui:'Space Grotesk','Inter','SF Pro Display',system-ui,-apple-system,'Segoe UI',sans-serif;
    --font-mono:'Recursive','IBM Plex Mono','Menlo','SFMono-Regular',monospace;
  }
  *,*::before,*::after{box-sizing:border-box;}
  html,body{margin:0;min-height:100%;}
  body{
    font-family:var(--font-ui);
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    -webkit-font-smoothing:antialiased;
    touch-action:manipulation;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background-image:radial-gradient(var(--grid) 1px, transparent 1px);
    background-size:12px 12px;
    opacity:0.92;
    pointer-events:none;
    z-index:-2;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,0.74) 0%, transparent 35%, transparent 70%, rgba(0,0,0,0.92) 100%);
    pointer-events:none;
    z-index:-1;
  }

  /* 音乐可视化背景 */
  .viz-container {
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:-1;
    opacity:0.6;
  }

  .viz-circle {
    position:absolute;
    border-radius:50%;
    border:1px solid;
    animation:expand 4s ease-out infinite;
  }

  @keyframes expand {
    0% { transform:scale(0); opacity:0.8; }
    100% { transform:scale(3); opacity:0; }
  }

  .viz-bar {
    position:absolute;
    bottom:0;
    width:2px;
    background:linear-gradient(to top, var(--accent), transparent);
    transform-origin:bottom;
    transition:height 0.1s ease;
  }
    header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:30px clamp(22px,5vw,54px) 18px;
    border-bottom:1px solid var(--border);
  }
  .brand{
    display:flex;
    align-items:center;
    gap:22px;
  }
  .glyph{
    width:56px;
    height:56px;
    border-radius:28px;
    border:1px solid var(--border-strong);
    display:grid;
    place-items:center;
    font-family:var(--font-display);
    font-size:19px;
    letter-spacing:0.46em;
    position:relative;
  }
  .glyph::after{
    content:"";
    position:absolute;
    inset:12px;
    border:1px dashed var(--border-strong);
    border-radius:24px;
  }
  .brand-text{
    display:flex;
    flex-direction:column;
    gap:6px;
    text-transform:uppercase;
  }
  .brand-text span{
    font-family:var(--font-display);
    font-size:clamp(20px,3.6vw,28px);
    letter-spacing:0.36em;
  }
  .brand-text em{
    font-style:normal;
    font-size:12px;
    letter-spacing:0.42em;
    color:var(--muted);
  }
  .actions{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  button{
    appearance:none;
    border:1px solid var(--border);
    background:var(--panel);
    color:var(--text);
    cursor:pointer;
    border-radius:999px;
    padding:10px 22px;
    font-size:12px;
    letter-spacing:0.24em;
    text-transform:uppercase;
    transition:border-color 0.25s ease, color 0.25s ease, background 0.25s ease;
    font-family:var(--font-display);
  }
  button:hover{border-color:var(--accent); color:var(--accent);}
  button:focus-visible{outline:2px dashed var(--accent); outline-offset:4px;}
  .preset-switch{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px;
    border-radius:999px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.65);
  }
  .preset{
    border:none;
    padding:8px 16px;
    background:transparent;
    color:var(--muted);
    font-size:11px;
    letter-spacing:0.2em;
  }
  .preset:hover{color:var(--accent);}
  .preset[aria-pressed="true"]{
    color:#050505;
    background:var(--accent);
    border-radius:999px;
  }
  #open-strudel{
    letter-spacing:0.18em;
  }
  #status-pill{
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 20px;
    border-radius:999px;
    border:1px dashed var(--border);
    background:var(--panel);
    font-size:12px;
    letter-spacing:0.32em;
    text-transform:uppercase;
    font-family:var(--font-display);
  }
  #status-pill .dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background:var(--border-strong);
    transition:background 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease;
  }
  #status-pill[data-state="ready"]{border-color:var(--accent); color:var(--accent);}
  #status-pill[data-state="ready"] .dot{background:var(--accent); box-shadow:0 0 8px rgba(255,0,79,0.65);}
  #status-pill[data-state="live"]{border-color:var(--accent); background:var(--accent-faint); color:var(--accent);}
  #status-pill[data-state="live"] .dot{background:var(--accent); box-shadow:0 0 14px rgba(255,0,79,0.8); transform:scale(1.1);}
  #status-pill[data-state="loading"]{border-color:var(--accent-alt); color:var(--accent-alt);}
  #status-pill[data-state="loading"] .dot{background:var(--accent-alt); animation:pulse 1.5s ease-in-out infinite;}
  #status-pill[data-state="error"]{border-color:#ff4444; color:#ff4444;}
  #status-pill[data-state="error"] .dot{background:#ff4444; animation:blink 1s ease-in-out infinite;}
  @keyframes pulse{0%,100%{opacity:0.6; transform:scale(0.95);} 50%{opacity:1; transform:scale(1.05);}}
  @keyframes blink{0%,50%{opacity:1;} 25%,75%{opacity:0.3;}}
  main{
    flex:1;
    display:grid;
    grid-template-rows:minmax(320px, 60vh) minmax(240px, 1fr);
    gap:clamp(18px,4vw,32px);
    padding:26px clamp(22px,6vw,56px) clamp(30px,6vw,56px);
  }
  .surface{
    position:relative;
    border-radius:26px;
    border:1px solid var(--border);
    background:var(--panel-alt);
    overflow:hidden;
  }
  #pad{touch-action:none;}
  #pad::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(transparent 80%, rgba(255,255,255,0.05) 80%, rgba(255,255,255,0.05) 82%, transparent 82%),
      linear-gradient(90deg, transparent 80%, rgba(255,255,255,0.05) 80%, rgba(255,255,255,0.05) 82%, transparent 82%);
    background-size:96px 96px;
    opacity:0.38;
    pointer-events:none;
    transition:opacity 0.35s ease;
    mix-blend-mode:screen;
  }
  #pad.is-active::before{opacity:0.72;}
  canvas{
    width:100%;
    height:100%;
    display:block;
    background:radial-gradient(circle at 50% 58%, rgba(255,0,79,0.12), transparent 62%),
               radial-gradient(circle at 48% 40%, rgba(255,122,0,0.08), transparent 68%),
               rgba(9,9,11,0.94);
  }
  .hud{
    position:absolute;
    top:28px;
    left:28px;
    display:grid;
    gap:10px;
    padding:20px 24px;
    border-radius:18px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.72);
    text-transform:uppercase;
    letter-spacing:0.28em;
    font-size:11px;
    pointer-events:none;
    font-family:var(--font-display);
  }
  .hud strong{font-size:15px; letter-spacing:0.42em;}
  .hud span{color:var(--muted);}
  .hud .tips{display:flex;flex-wrap:wrap;gap:8px;}
  .hud .tips span{
    padding:6px 12px;
    border:1px solid var(--border);
    border-radius:999px;
    letter-spacing:0.24em;
  }
  .embed iframe{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
  }
  .frame-label{
    position:absolute;
    top:24px;
    left:24px;
    padding:8px 16px;
    border-radius:16px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.72);
    text-transform:uppercase;
    letter-spacing:0.3em;
    font-size:11px;
    color:var(--muted);
    pointer-events:none;
    font-family:var(--font-display);
  }
  .preset-info{
    margin-top:12px;
    padding:18px 22px;
    border-radius:18px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.7);
    display:flex;
    flex-direction:row;
    gap:20px;
    flex-wrap:wrap;
    align-items:center;
  }
  .preset-meta{
    min-width:220px;
  }
  .preset-title{
    font-family:var(--font-display);
    font-size:13px;
    letter-spacing:0.3em;
    display:block;
    margin-bottom:6px;
    text-transform:uppercase;
  }
  .preset-meta p{
    margin:0;
    font-size:13px;
    color:var(--muted);
    letter-spacing:0.04em;
  }
  .preset-steps{
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:12px;
    color:var(--muted);
    letter-spacing:0.08em;
  }
  .preset-steps strong{color:var(--accent); font-weight:600; letter-spacing:0.04em;}
  #gate{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    background:rgba(6,6,8,0.9);
    border-top:1px solid var(--border);
    border-bottom:1px solid var(--border);
    z-index:20;
  }
  #gate[hidden]{display:none;}
  .gate-card{
    max-width:430px;
    width:100%;
    padding:38px clamp(24px,6vw,46px);
    border:1px dashed var(--border-strong);
    border-radius:26px;
    background:rgba(9,9,11,0.85);
    text-align:center;
    display:grid;
    gap:20px;
    text-transform:uppercase;
    letter-spacing:0.32em;
    font-family:var(--font-display);
  }
  .gate-card h2{margin:0;font-size:18px;}
  .gate-card p{margin:0;color:var(--muted);font-size:12px;}
  .primary{background:var(--accent);color:#050505;border-color:var(--accent);}
  .primary:hover{background:transparent;color:var(--accent);}
  @media (max-width:900px){
    header{flex-direction:column;align-items:flex-start;gap:20px;padding-top:24px;}
    .actions{width:100%;justify-content:flex-start;}
    main{grid-template-rows:minmax(280px, 48vh) minmax(260px, 1fr);} 
    .hud{top:22px;left:22px;padding:18px 20px;letter-spacing:0.22em;}
    .hud strong{letter-spacing:0.32em;}
    .preset-info{flex-direction:column;align-items:flex-start;}
  }
  @media (max-width:640px){
    button{font-size:10px;letter-spacing:0.18em;padding:9px 18px;}
    #status-pill{font-size:10px;letter-spacing:0.22em;}
    .hud{font-size:10px;}
    .frame-label{letter-spacing:0.24em;font-size:10px;}
    .preset{padding:8px 12px;font-size:10px;letter-spacing:0.18em;}
    .preset-info{padding:16px 18px;}
    .preset-title{font-size:12px;}
    .preset-steps{font-size:11px;}
  }
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important;}
  }
</style>
</head>
<body>
<!-- 音乐可视化背景容器 -->
<div class="viz-container" id="viz-container"></div>

<header>
  <div class="brand">
    <div class="glyph" aria-hidden="true">TP</div>
    <div class="brand-text">
      <span>TusicPadWeb</span>
      <em>Pencil → Strudel Shell</em>
    </div>
  </div>
<div class="actions">
    <button id="open-strudel" type="button" aria-label="Open Strudel in new tab">Open Strudel</button>
    <div class="preset-switch" role="group" aria-label="Strudel patch presets">
      <button class="preset" data-patch="tusic" aria-pressed="true">TusicPad</button>
      <button class="preset" data-patch="synth" aria-pressed="false">Synth</button>
      <button class="preset" data-patch="ambient" aria-pressed="false">Ambient</button>
      <button class="preset" data-patch="techno" aria-pressed="false">Techno</button>
    </div>
    <span id="status-pill" data-state="waiting">
      <span class="dot" aria-hidden="true"></span>
      <span id="status-text">Init</span>
    </span>
  </div>
</header>

<main>
  <section id="pad" class="surface" aria-label="Pencil 捕获区域">
    <canvas id="cv"></canvas>
    <div class="hud">
      <strong>Draw • Sync • Play</strong>
      <span>Apple Pencil 的位置与压力将驱动 Strudel。</span>
      <div class="tips">
        <span>X → Rhythm</span>
        <span>Y → Pitch</span>
        <span>Pressure → Gain</span>
      </div>
    </div>
  </section>
  <section class="surface embed" aria-label="Strudel REPL">
    <iframe id="strudel" src="about:blank" allow="autoplay; clipboard-read; clipboard-write" title="Strudel REPL"></iframe>
    <div class="frame-label">Strudel Repl · Press Run ▶︎ · Then Draw Above</div>
  </section>

  <section class="preset-info" aria-live="polite">
    <div class="preset-meta">
      <span class="preset-title" id="preset-name">TusicPad Default</span>
      <p id="preset-desc">Kick + strings + hats with Pencil mapped to rhythm / pitch / pressure.</p>
    </div>
    <div class="preset-steps" id="preset-steps">
      <span>① 在下方 Strudel 中按一次 <strong>Run ▶︎</strong> 解锁声音</span>
      <span>② 返回上方画布，用 Pencil 控制节奏 / 音高 / 质感</span>
    </div>
  </section>
</main>

<div id="gate" role="dialog" aria-modal="true">
  <div class="gate-card">
    <h2>Initiate Session</h2>
    <p>点击 Start，然后在下方 Strudel REPL 中按 Run（默认已加载 TusicPad Patch）。</p>
    <button id="open" class="primary" type="button">Start</button>
  </div>
</div>

<script>
const pad = document.getElementById('pad');
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const strudelFrame = document.getElementById('strudel');
const statusPill = document.getElementById('status-pill');
const statusText = document.getElementById('status-text');
const openStrudelButton = document.getElementById('open-strudel');
const gate = document.getElementById('gate');
const openButton = document.getElementById('open');
const presetButtons = Array.from(document.querySelectorAll('.preset[data-patch]'));
const presetName = document.getElementById('preset-name');
const presetDesc = document.getElementById('preset-desc');

const statusCopy = {
  waiting: 'Init',
  loading: 'Loading',
  ready: 'Ready',
  live: 'Live',
  error: 'Error'
};

const dotPalette = ['#ff004f', '#ff7a00', '#ffd000', '#00ffcc', '#ff00ff'];
const textEncoder = typeof TextEncoder !== 'undefined' ? new TextEncoder() : null;
const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
let fadeHandle = null;
let colorIndex = 0;
let lastSent = 0;
let settleTimer;
let currentPatch = null;

// 可视化相关变量
let vizContainer = null;
let bars = [];
let circles = [];
let animationFrame = null;

const patches = {
  'synth': {
    id: 'synth',
    name: 'Synth Patch',
    description: 'Pure oscillators mapped to x/y/pressure — works on all devices.',
    code: `// === Synth Patch: works on all devices ===
// 接收 Pencil 数据
globalThis.pen = { x:0.5, y:0.5, p:0.0 };
let state = { x:0.5, y:0.5, p:0.0 };
const lerp = (a,b,t)=>a+(b-a)*t;

// 平滑处理
setInterval(()=>{
  state.x = lerp(state.x, pen.x, 0.2);
  state.y = lerp(state.y, pen.y, 0.2);
  state.p = lerp(state.p, pen.p, 0.2);
}, 30);

// WebAudio 合成器
let __ctx = null;
function ensureCtx(){
  try{
    if(!__ctx){
      const C = window.AudioContext || window.webkitAudioContext;
      if(!C) return null;
      __ctx = new C();
    }
    if(__ctx.state === 'suspended') __ctx.resume();
    return __ctx;
  }catch(_){ return null; }
}

function synth(freq, amp, dur=0.15){
  const ctx = ensureCtx();
  if(!ctx) return;
  const now = ctx.currentTime;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  // 根据x位置选择波形
  osc.type = state.x > 0.6 ? 'sawtooth' : state.x > 0.3 ? 'triangle' : 'sine';
  osc.frequency.setValueAtTime(freq, now);

  gain.gain.setValueAtTime(0.001, now);
  gain.gain.exponentialRampToValueAtTime(Math.max(0.05, amp*0.4), now + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, now + dur);

  osc.connect(gain).connect(ctx.destination);
  osc.start(now);
  osc.stop(now + dur);
}

// 消息处理
window.addEventListener('message', (e)=>{
  const d = e.data;
  if(!d || d.type!=='pen') return;
  pen.x = Math.max(0, Math.min(1, d.x));
  pen.y = Math.max(0, Math.min(1, d.y));
  pen.p = Math.max(0, Math.min(1, d.pressure || 0.35));

  // 限流触发
  const t = performance.now();
  if(!synth.lastFire || t - synth.lastFire > 100){
    // y→音高 (midi 36-72)
    const midi = 36 + Math.floor((1 - state.y) * 36);
    const freq = 440 * Math.pow(2, (midi - 69)/12);
    const amp = state.p;
    synth(freq, amp, 0.15 + state.p*0.1);
    synth.lastFire = t;
  }
});

// 视觉占位
$: stack(s('~')).gain(0.0001)
._pianoroll({cycles:4})._spectrum({speed:0.5})`
  },
  'tusic': {
    id: 'tusic',
    name: 'TusicPad Default',
    description: 'Kick + strings + hats with Pencil mapped to rhythm / pitch / pressure.',
    code: `// === TusicPad Default ===
globalThis.pen = { x:0.5, y:0.5, p:0.0 };
let state = { x:0.5, y:0.5, p:0.0 };
const lerp = (a,b,t)=>a+(b-a)*t;

window.addEventListener('message', (e)=>{
  const d = e.data;
  if(!d || d.type!=='pen') return;
  pen.x = Math.max(0, Math.min(1, d.x));
  pen.y = Math.max(0, Math.min(1, d.y));
  pen.p = Math.max(0, Math.min(1, d.pressure || 0));
});

setInterval(()=>{
  state.x = lerp(state.x, pen.x, 0.18);
  state.y = lerp(state.y, pen.y, 0.18);
  state.p = lerp(state.p, pen.p, 0.22);
}, 28);

$: stack(
  // Kick layer
  s('bd ~ sd ~').gain(()=>0.45 + state.p*0.8).speed(()=>0.9 + state.x*0.4),

  // String melody
  note(()=> midi(48 + Math.floor((1 - state.y)*18)))
    .sound('gm_strings')
    .gain(()=> 0.32 + state.p*0.6)
    .shape(()=> state.x)
    .pan(()=> state.x*2-1),

  // Hi-hats
  s('hh*4').gain(()=> state.p*0.5).hp(5000).speed(()=> 1 + state.x*0.5)
)
._pianoroll({cycles:4})._spectrum({speed:0.5}).gain(0.9)`
  },
  'ambient': {
    id: 'ambient',
    name: 'Ambient Dreams',
    description: 'Atmospheric pads and melodic textures with Pencil control.',
    code: `// === Ambient Dreams ===
globalThis.pen = { x:0.5, y:0.5, p:0.0 };
let state = { x:0.5, y:0.5, p:0.0 };
const lerp = (a,b,t)=>a+(b-a)*t;

window.addEventListener('message', (e)=>{
  const d = e.data;
  if(!d || d.type!=='pen') return;
  pen.x = Math.max(0, Math.min(1, d.x));
  pen.y = Math.max(0, Math.min(1, d.y));
  pen.p = Math.max(0, Math.min(1, d.pressure || 0));
});

setInterval(()=>{
  state.x = lerp(state.x, pen.x, 0.12);
  state.y = lerp(state.y, pen.y, 0.12);
  state.p = lerp(state.p, pen.p, 0.15);
}, 32);

$: stack(
  // 氛围和声
  note("<c3 eb3 g3 bb3>*2").sound('padscape')
    .gain(0.3 + state.p*0.4)
    .lp(800 + state.y*2000)
    .pan(state.x*2-1)
    .shape(0.8),

  // 钟琴旋律
  note(scale('c4 minor', "[0 2 4 7]")).sound('gam')
    .gain(0.2 + state.p*0.3)
    .speed(0.5 + state.x*0.5)
    .decay(2),

  // 环境纹理
  s('crayon*8').gain(state.p*0.15).lp(3000).pan(state.x*2-1),

  // 低音铺垫
  note("<c2 g2>*4").sound('bass').gain(0.15 + state.p*0.2).lp(200)
)
._pianoroll({cycles:8})._spectrum({speed:0.3}).gain(1.2)`
  },
  'techno': {
    id: 'techno',
    name: 'Techno Groove',
    description: 'Driving techno beats with synth leads controlled by Pencil.',
    code: `// === Techno Groove ===
globalThis.pen = { x:0.5, y:0.5, p:0.0 };
let state = { x:0.5, y:0.5, p:0.0 };
const lerp = (a,b,t)=>a+(b-a)*t;

window.addEventListener('message', (e)=>{
  const d = e.data;
  if(!d || d.type!=='pen') return;
  pen.x = Math.max(0, Math.min(1, d.x));
  pen.y = Math.max(0, Math.min(1, d.y));
  pen.p = Math.max(0, Math.min(1, d.pressure || 0));
});

setInterval(()=>{
  state.x = lerp(state.x, pen.x, 0.25);
  state.y = lerp(state.y, pen.y, 0.25);
  state.p = lerp(state.p, pen.p, 0.3);
}, 25);

$: stack(
  // 主鼓组
  s("bd*4, sd*4").gain(0.6 + state.p*0.4)
    .speed(()=>0.8 + state.x*0.4)
    .sometimes(by(0.1), s('cp')),

  // 踩镲模式
  s("hh*8").gain(0.2 + state.p*0.3)
    .speed(()=>1 + state.x*0.5)
    .sometimes(by(0.15), s('oh')),

  // 合成器贝斯
  note("[c1 c2 g1]*2").sound('sawtooth')
    .gain(0.4 + state.p*0.4)
    .lp(100 + state.y*400)
    .pan(state.x*2-1)
    .shape(0.9),

  // 主旋律
  note(scale('c3 minor', "[0 3 5 7 10]")).sound('superpiano')
    .gain(0.25 + state.p*0.35)
    .speed(()=>0.5 + state.x*0.8)
    .pan(state.x*2-1)
    .decay(0.8),

  // 效果声
  s("glitch*4").gain(state.p*0.2).hp(5000).speed(2)
)
._pianoroll({cycles:4})._spectrum({speed:1}).gain(1.1)`
  }
};

function setActivePreset(patchId){
  presetButtons.forEach(btn => {
    const active = btn.dataset.patch === patchId;
    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
  });
}

function encodeCodeToHash(code){
  try {
    if(textEncoder){
      const bytes = textEncoder.encode(code);
      let binary = '';
      bytes.forEach(byte => {
        binary += String.fromCharCode(byte);
      });
      return btoa(binary);
    }
  } catch (error) {
    // fallback below
  }
  return btoa(unescape(encodeURIComponent(code)));
}

function buildStrudelUrl(code){
  // 使用缓存破坏的URL格式，同时保持兼容性
  const hash = encodeURIComponent(encodeCodeToHash(code));
  const bust = Date.now().toString(36);
  return `https://strudel.cc/#${hash}&v=${bust}`;
}

// 备用URL构建方法，直接使用Strudel主页
function buildStrudelBaseUrl(){
  return 'https://strudel.cc/';
}

function loadPatch(patchId, reload = true){
  const patch = patches[patchId];
  if(!patch) return;
  const wasSame = currentPatch && currentPatch.id === patch.id;
  currentPatch = patch;
  setActivePreset(patch.id);
  presetName.textContent = patch.name;
  presetDesc.textContent = patch.description;

  if(!wasSame || reload || !strudelFrame.src.includes('strudel.cc')){
    // 添加加载状态
    setStatus('loading');

    // 首先尝试加载预设代码URL
    const targetUrl = buildStrudelUrl(patch.code);
    loadWithFallback(targetUrl, patch);
  }
  pad.classList.remove('is-active');
}

function loadWithFallback(primaryUrl, patch) {
  let attemptCount = 0;
  const maxAttempts = 2;

  const tryLoad = (url) => {
    attemptCount++;
    console.log(`Loading Strudel (attempt ${attemptCount}):`, url);

    strudelFrame.onload = () => {
      console.log('Strudel iframe loaded successfully');
      setStatus('ready');

      // 发送初始化消息确保连接建立
      setTimeout(() => {
        try {
          const target = strudelFrame.contentWindow;
          if(target) {
            target.postMessage({ type: 'init', source: 'tusicpad', patch: patch.id }, 'https://strudel.cc');
          }
        } catch (error) {
          console.warn('Failed to send init message:', error);
        }
      }, 500);
    };

    strudelFrame.onerror = () => {
      console.error(`Failed to load Strudel iframe (attempt ${attemptCount}):`, url);

      if(attemptCount < maxAttempts) {
        // 如果第一次尝试失败，尝试基础URL
        if(attemptCount === 1) {
          console.log('Retrying with base URL...');
          tryLoad(buildStrudelBaseUrl());
        } else {
          setStatus('error');
        }
      } else {
        setStatus('error');
        // 显示手动复制代码的选项
        showManualCodeOption(patch);
      }
    };

    strudelFrame.src = url;
  };

  tryLoad(primaryUrl);
}

function showManualCodeOption(patch) {
  const steps = document.getElementById('preset-steps');
  steps.innerHTML = `
    <span style="color: #ff4444;">⚠️ 自动加载失败，请手动操作：</span>
    <span>① 在下方打开 <a href="https://strudel.cc/" target="_blank" style="color: var(--accent);">strudel.cc</a></span>
    <span>② 复制下方代码并粘贴到 Strudel 编辑器中</span>
    <span>③ 按 <strong>Run ▶︎</strong> 开始演奏</span>
  `;

  // 创建代码显示区域
  const codeDisplay = document.createElement('div');
  codeDisplay.style.cssText = `
    margin-top: 16px;
    padding: 16px;
    background: rgba(8,8,10,0.9);
    border: 1px dashed var(--border);
    border-radius: 12px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text);
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
  `;
  codeDisplay.textContent = patch.code;

  steps.parentNode.appendChild(codeDisplay);
}

function setStatus(state){
  statusPill.dataset.state = state;
  statusText.textContent = statusCopy[state] || '';
}

function resizeCanvas(){
  const rect = pad.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const width = Math.max(1, Math.floor(rect.width * dpr));
  const height = Math.max(1, Math.floor(rect.height * dpr));
  if(canvas.width !== width || canvas.height !== height){
    canvas.width = width;
    canvas.height = height;
  }
}

function clearCanvas(){
  ctx.save();
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'rgba(8,8,10,1)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();
  colorIndex = 0;
}

function fadeFrame(){
  ctx.fillStyle = 'rgba(7,7,9,0.18)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  fadeHandle = requestAnimationFrame(fadeFrame);
}

function drawDot(x, y, pressure){
  const radius = (6 + pressure * 16) * (window.devicePixelRatio || 1);
  const color = dotPalette[colorIndex % dotPalette.length];
  ctx.fillStyle = color + (pressure > 0.45 ? 'dd' : 'bb');
  ctx.beginPath();
  ctx.arc(x * canvas.width, y * canvas.height, radius, 0, Math.PI * 2);
  ctx.fill();
  colorIndex += 1;
}

function sendPen(x, y, pressure){
  const target = strudelFrame.contentWindow;
  if(!target) {
    console.warn('Strudel iframe contentWindow not available');
    setStatus('error');
    return;
  }

  try {
    target.postMessage({ type: 'pen', x, y, pressure, t: performance.now() }, 'https://strudel.cc');
    console.log('Pen data sent:', { x, y, pressure });

    // 触发可视化效果
    if(vizContainer) {
      updateVisualization(x, y, pressure);
    }
  } catch (error) {
    console.error('Failed to send pen data:', error);
    setStatus('error');
  }
}

// 可视化初始化函数
function initVisualization() {
  vizContainer = document.getElementById('viz-container');
  if(!vizContainer) return;

  // 创建频谱条
  const barCount = 32;
  for(let i = 0; i < barCount; i++) {
    const bar = document.createElement('div');
    bar.className = 'viz-bar';
    bar.style.left = `${(i / barCount) * 100}%`;
    bar.style.height = '0%';
    bar.style.background = `linear-gradient(to top, ${dotPalette[i % dotPalette.length]}, transparent)`;
    vizContainer.appendChild(bar);
    bars.push(bar);
  }
}

// 更新可视化效果
function updateVisualization(x, y, pressure) {
  if(!vizContainer || bars.length === 0) return;

  // 更新频谱条
  bars.forEach((bar, i) => {
    const targetX = i / bars.length;
    const distance = Math.abs(targetX - x);
    const influence = Math.max(0, 1 - distance * 3);
    const height = pressure * influence * 80 + Math.random() * pressure * 20;

    bar.style.height = `${Math.min(100, height)}%`;
    bar.style.opacity = 0.3 + influence * 0.7;
  });

  // 创建扩散圆圈效果
  if(pressure > 0.3 && Math.random() < pressure * 0.5) {
    createCircle(x, y, pressure);
  }
}

// 创建扩散圆圈
function createCircle(x, y, pressure) {
  const circle = document.createElement('div');
  circle.className = 'viz-circle';
  const size = 50 + pressure * 150;
  const color = dotPalette[Math.floor(Math.random() * dotPalette.length)];

  circle.style.width = `${size}px`;
  circle.style.height = `${size}px`;
  circle.style.left = `${x * window.innerWidth - size/2}px`;
  circle.style.top = `${y * window.innerHeight - size/2}px`;
  circle.style.borderColor = color;
  circle.style.opacity = 0.3 + pressure * 0.4;

  vizContainer.appendChild(circle);
  circles.push(circle);

  // 自动清理
  setTimeout(() => {
    if(circle.parentNode) {
      circle.parentNode.removeChild(circle);
    }
    const index = circles.indexOf(circle);
    if(index > -1) circles.splice(index, 1);
  }, 4000);
}

// 动画循环
function animateVisualization() {
  if(!vizContainer) return;

  // 自然衰减频谱条
  bars.forEach(bar => {
    const currentHeight = parseFloat(bar.style.height) || 0;
    const newHeight = currentHeight * 0.92;
    bar.style.height = `${newHeight}%`;

    const currentOpacity = parseFloat(bar.style.opacity) || 0;
    const newOpacity = currentOpacity * 0.95;
    bar.style.opacity = `${Math.max(0.1, newOpacity)}`;
  });

  if(!reduceMotion) {
    animationFrame = requestAnimationFrame(animateVisualization);
  }
}

function updateInteractionState(){
  pad.classList.add('is-active');
  setStatus('live');
  clearTimeout(settleTimer);
  settleTimer = setTimeout(() => {
    pad.classList.remove('is-active');
    setStatus('ready');
  }, 1100);
}

function pointerToCanvas(event){
  const rect = canvas.getBoundingClientRect();
  const x = (event.clientX - rect.left) / rect.width;
  const y = (event.clientY - rect.top) / rect.height;

  // 多系统压力检测
  let pressure = 0.35; // 默认值

  if (typeof event.pressure === 'number') {
    pressure = event.pressure;
  } else if (event.force && typeof event.force === 'number') {
    // iOS Safari 支持
    pressure = event.force;
  } else if (event.mozPressure !== undefined) {
    // Firefox 支持
    pressure = event.mozPressure;
  } else if (event.webkitForce !== undefined) {
    // 旧版 WebKit 支持
    pressure = event.webkitForce;
  }

  // 确保压力值在有效范围内
  pressure = Math.max(0, Math.min(1, pressure));

  return {
    x: Math.min(1, Math.max(0, x)),
    y: Math.min(1, Math.max(0, y)),
    pressure: pressure
  };
}

function isSupportedPointer(event){
  // 支持更多输入类型
  const supportedTypes = ['pen', 'touch', 'mouse'];

  // 如果设备报告了 pressure 或 force，则认为是支持的输入
  if (typeof event.pressure === 'number' && event.pressure > 0) return true;
  if (event.force && typeof event.force === 'number' && event.force > 0) return true;
  if (event.mozPressure !== undefined && event.mozPressure > 0) return true;
  if (event.webkitForce !== undefined && event.webkitForce > 0) return true;

  return supportedTypes.includes(event.pointerType);
}

// 跨浏览器事件处理
function addCrossBrowserListeners(element, downHandler, moveHandler, upHandler) {
  // 现代浏览器 Pointer Events
  if (window.PointerEvent) {
    element.addEventListener('pointerdown', downHandler, { passive: true });
    element.addEventListener('pointermove', moveHandler, { passive: true });
    element.addEventListener('pointerup', upHandler, { passive: true });
    element.addEventListener('pointerleave', upHandler, { passive: true });
  } else {
    // 旧版浏览器回退
    element.addEventListener('mousedown', downHandler);
    element.addEventListener('mousemove', moveHandler);
    element.addEventListener('mouseup', upHandler);
    element.addEventListener('mouseleave', upHandler);

    // Touch 设备支持
    if ('ontouchstart' in window) {
      element.addEventListener('touchstart', downHandler, { passive: true });
      element.addEventListener('touchmove', moveHandler, { passive: true });
      element.addEventListener('touchend', upHandler, { passive: true });
    }
  }
}

// 事件处理器
const handlePointerDown = (event) => {
  if(!isSupportedPointer(event)) return;

  // 阻止默认行为以获得最佳性能
  if (event.preventDefault) {
    event.preventDefault();
  }

  const data = pointerToCanvas(event);
  drawDot(data.x, data.y, data.pressure);
  sendPen(data.x, data.y, data.pressure);
  updateInteractionState();
};

const handlePointerMove = (event) => {
  if(!isSupportedPointer(event)) return;

  // 只在按下时响应（减少不必要的处理）
  const isPressed = event.buttons !== undefined ?
    (event.buttons & 1) === 1 : // 鼠标左键
    (event.type === 'touchmove' || event.type === 'pointermove');

  if(!isPressed) return;

  const data = pointerToCanvas(event);
  drawDot(data.x, data.y, data.pressure);
  const now = performance.now();

  // 限制发送频率以提高性能
  if(now - lastSent > 16) {
    sendPen(data.x, data.y, data.pressure);
    lastSent = now;
  }
  updateInteractionState();
};

const handlePointerUp = () => {
  clearTimeout(settleTimer);
  settleTimer = setTimeout(() => {
    pad.classList.remove('is-active');
    setStatus('ready');
  }, 620);
};

// 添加事件监听器
addCrossBrowserListeners(pad, handlePointerDown, handlePointerMove, handlePointerUp);



openButton.addEventListener('click', () => {
  gate.setAttribute('hidden', 'true');
  setStatus('loading');

  // 确保Strudel已正确加载
  const checkStrudelReady = () => {
    try {
      const target = strudelFrame.contentWindow;
      if(target && target.location && target.location.href.includes('strudel.cc')) {
        console.log('Strudel is ready, sending focus hint');
        target.postMessage({ type: 'hint', action: 'focus' }, 'https://strudel.cc');
        setStatus('ready');

        // 添加调试信息
        setTimeout(() => {
          console.log('Current patch loaded:', currentPatch?.name);
          console.log('Strudel URL:', strudelFrame.src);
        }, 1000);
      } else {
        console.log('Strudel not ready yet, retrying...');
        setTimeout(checkStrudelReady, 1000);
      }
    } catch (error) {
      console.warn('Cannot access Strudel iframe yet:', error);
      setTimeout(checkStrudelReady, 1000);
    }
  };

  // 延迟检查确保iframe有足够时间加载
  setTimeout(checkStrudelReady, 500);
});

if(openStrudelButton){
  openStrudelButton.addEventListener('click', () => {
    window.open(strudelFrame.src, '_blank', 'noopener,noreferrer');
  });
}

presetButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    loadPatch(btn.dataset.patch, true);
  });
});

window.addEventListener('resize', resizeCanvas, { passive: true });
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 280));

loadPatch('tusic', false);
resizeCanvas();
clearCanvas();

// 初始化可视化系统
initVisualization();

if(!reduceMotion){
  fadeHandle = requestAnimationFrame(fadeFrame);
  animationFrame = requestAnimationFrame(animateVisualization);
}

window.addEventListener('beforeunload', () => {
  if(fadeHandle){
    cancelAnimationFrame(fadeHandle);
  }
  if(animationFrame){
    cancelAnimationFrame(animationFrame);
  }
});

</script>
</body>
</html>
