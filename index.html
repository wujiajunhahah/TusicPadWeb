<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TusicPadWeb — Pencil ▶︎ Strudel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Inter:wght@400;500;600&family=Recursive:wght@400;500&family=Space+Grotesk:wght@400;500;600&family=VT323&display=swap" rel="stylesheet">
<style>
  :root{
    color-scheme:dark;
    --bg:#050505;
    --grid:#0f0f10;
    --panel:#0b0b0d;
    --panel-alt:#101012;
    --border:#1b1b1f;
    --border-strong:#2d2d33;
    --accent:#ff004f;
    --accent-alt:#ff7a00;
    --accent-faint:rgba(255,0,79,0.18);
    --text:#f5f6f7;
    --muted:rgba(243,244,246,0.58);
    --font-display:'DotGothic16','VT323','Recursive','Space Grotesk',monospace;
    --font-ui:'Space Grotesk','Inter','SF Pro Display',system-ui,-apple-system,'Segoe UI',sans-serif;
    --font-mono:'Recursive','IBM Plex Mono','Menlo','SFMono-Regular',monospace;
  }
  *,*::before,*::after{box-sizing:border-box;}
  html,body{margin:0;min-height:100%;}
  body{
    font-family:var(--font-ui);
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    -webkit-font-smoothing:antialiased;
    touch-action:manipulation;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background-image:radial-gradient(var(--grid) 1px, transparent 1px);
    background-size:12px 12px;
    opacity:0.92;
    pointer-events:none;
    z-index:-2;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,0.74) 0%, transparent 35%, transparent 70%, rgba(0,0,0,0.92) 100%);
    pointer-events:none;
    z-index:-1;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:30px clamp(22px,5vw,54px) 18px;
    border-bottom:1px solid var(--border);
  }
  .brand{
    display:flex;
    align-items:center;
    gap:22px;
  }
  .glyph{
    width:56px;
    height:56px;
    border-radius:28px;
    border:1px solid var(--border-strong);
    display:grid;
    place-items:center;
    font-family:var(--font-display);
    font-size:19px;
    letter-spacing:0.46em;
    position:relative;
  }
  .glyph::after{
    content:"";
    position:absolute;
    inset:12px;
    border:1px dashed var(--border-strong);
    border-radius:24px;
  }
  .brand-text{
    display:flex;
    flex-direction:column;
    gap:6px;
    text-transform:uppercase;
  }
  .brand-text span{
    font-family:var(--font-display);
    font-size:clamp(20px,3.6vw,28px);
    letter-spacing:0.36em;
  }
  .brand-text em{
    font-style:normal;
    font-size:12px;
    letter-spacing:0.42em;
    color:var(--muted);
  }
  .actions{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  button{
    appearance:none;
    border:1px solid var(--border);
    background:var(--panel);
    color:var(--text);
    cursor:pointer;
    border-radius:999px;
    padding:10px 22px;
    font-size:12px;
    letter-spacing:0.24em;
    text-transform:uppercase;
    transition:border-color 0.25s ease, color 0.25s ease, background 0.25s ease;
    font-family:var(--font-display);
  }
  button:hover{border-color:var(--accent); color:var(--accent);}
  button:focus-visible{outline:2px dashed var(--accent); outline-offset:4px;}
  .preset-switch{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px;
    border-radius:999px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.65);
  }
  .preset{
    border:none;
    padding:8px 16px;
    background:transparent;
    color:var(--muted);
    font-size:11px;
    letter-spacing:0.2em;
  }
  .preset:hover{color:var(--accent);}
  .preset[aria-pressed="true"]{
    color:#050505;
    background:var(--accent);
    border-radius:999px;
  }
  #open-strudel{
    letter-spacing:0.18em;
  }
  #status-pill{
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 20px;
    border-radius:999px;
    border:1px dashed var(--border);
    background:var(--panel);
    font-size:12px;
    letter-spacing:0.32em;
    text-transform:uppercase;
    font-family:var(--font-display);
  }
  #status-pill .dot{
    width:10px;
    height:10px;
    border-radius:50%;
    background:var(--border-strong);
    transition:background 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease;
  }
  #status-pill[data-state="ready"]{border-color:var(--accent); color:var(--accent);}
  #status-pill[data-state="ready"] .dot{background:var(--accent); box-shadow:0 0 8px rgba(255,0,79,0.65);}
  #status-pill[data-state="live"]{border-color:var(--accent); background:var(--accent-faint); color:var(--accent);}
  #status-pill[data-state="live"] .dot{background:var(--accent); box-shadow:0 0 14px rgba(255,0,79,0.8); transform:scale(1.1);}
  main{
    flex:1;
    display:grid;
    grid-template-rows:minmax(320px, 60vh) minmax(240px, 1fr);
    gap:clamp(18px,4vw,32px);
    padding:26px clamp(22px,6vw,56px) clamp(30px,6vw,56px);
  }
  .surface{
    position:relative;
    border-radius:26px;
    border:1px solid var(--border);
    background:var(--panel-alt);
    overflow:hidden;
  }
  #pad{touch-action:none;}
  #pad::before{
    content:"";
    position:absolute;
    inset:0;
    background:
      linear-gradient(transparent 80%, rgba(255,255,255,0.05) 80%, rgba(255,255,255,0.05) 82%, transparent 82%),
      linear-gradient(90deg, transparent 80%, rgba(255,255,255,0.05) 80%, rgba(255,255,255,0.05) 82%, transparent 82%);
    background-size:96px 96px;
    opacity:0.38;
    pointer-events:none;
    transition:opacity 0.35s ease;
    mix-blend-mode:screen;
  }
  #pad.is-active::before{opacity:0.72;}
  canvas{
    width:100%;
    height:100%;
    display:block;
    background:radial-gradient(circle at 50% 58%, rgba(255,0,79,0.12), transparent 62%),
               radial-gradient(circle at 48% 40%, rgba(255,122,0,0.08), transparent 68%),
               rgba(9,9,11,0.94);
  }
  .hud{
    position:absolute;
    top:28px;
    left:28px;
    display:grid;
    gap:10px;
    padding:20px 24px;
    border-radius:18px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.72);
    text-transform:uppercase;
    letter-spacing:0.28em;
    font-size:11px;
    pointer-events:none;
    font-family:var(--font-display);
  }
  .hud strong{font-size:15px; letter-spacing:0.42em;}
  .hud span{color:var(--muted);}
  .hud .tips{display:flex;flex-wrap:wrap;gap:8px;}
  .hud .tips span{
    padding:6px 12px;
    border:1px solid var(--border);
    border-radius:999px;
    letter-spacing:0.24em;
  }
  .embed iframe{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
  }
  .frame-label{
    position:absolute;
    top:24px;
    left:24px;
    padding:8px 16px;
    border-radius:16px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.72);
    text-transform:uppercase;
    letter-spacing:0.3em;
    font-size:11px;
    color:var(--muted);
    pointer-events:none;
    font-family:var(--font-display);
  }
  .preset-info{
    margin-top:12px;
    padding:18px 22px;
    border-radius:18px;
    border:1px dashed var(--border);
    background:rgba(8,8,10,0.7);
    display:flex;
    flex-direction:row;
    gap:20px;
    flex-wrap:wrap;
    align-items:center;
  }
  .preset-meta{
    min-width:220px;
  }
  .preset-title{
    font-family:var(--font-display);
    font-size:13px;
    letter-spacing:0.3em;
    display:block;
    margin-bottom:6px;
    text-transform:uppercase;
  }
  .preset-meta p{
    margin:0;
    font-size:13px;
    color:var(--muted);
    letter-spacing:0.04em;
  }
  .preset-steps{
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:12px;
    color:var(--muted);
    letter-spacing:0.08em;
  }
  .preset-steps strong{color:var(--accent); font-weight:600; letter-spacing:0.04em;}
  #gate{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    background:rgba(6,6,8,0.9);
    border-top:1px solid var(--border);
    border-bottom:1px solid var(--border);
    z-index:20;
  }
  #gate[hidden]{display:none;}
  .gate-card{
    max-width:430px;
    width:100%;
    padding:38px clamp(24px,6vw,46px);
    border:1px dashed var(--border-strong);
    border-radius:26px;
    background:rgba(9,9,11,0.85);
    text-align:center;
    display:grid;
    gap:20px;
    text-transform:uppercase;
    letter-spacing:0.32em;
    font-family:var(--font-display);
  }
  .gate-card h2{margin:0;font-size:18px;}
  .gate-card p{margin:0;color:var(--muted);font-size:12px;}
  .primary{background:var(--accent);color:#050505;border-color:var(--accent);}
  .primary:hover{background:transparent;color:var(--accent);}
  @media (max-width:900px){
    header{flex-direction:column;align-items:flex-start;gap:20px;padding-top:24px;}
    .actions{width:100%;justify-content:flex-start;}
    main{grid-template-rows:minmax(280px, 48vh) minmax(260px, 1fr);} 
    .hud{top:22px;left:22px;padding:18px 20px;letter-spacing:0.22em;}
    .hud strong{letter-spacing:0.32em;}
    .preset-info{flex-direction:column;align-items:flex-start;}
  }
  @media (max-width:640px){
    button{font-size:10px;letter-spacing:0.18em;padding:9px 18px;}
    #status-pill{font-size:10px;letter-spacing:0.22em;}
    .hud{font-size:10px;}
    .frame-label{letter-spacing:0.24em;font-size:10px;}
    .preset{padding:8px 12px;font-size:10px;letter-spacing:0.18em;}
    .preset-info{padding:16px 18px;}
    .preset-title{font-size:12px;}
    .preset-steps{font-size:11px;}
  }
  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important;}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="glyph" aria-hidden="true">TP</div>
    <div class="brand-text">
      <span>TusicPadWeb</span>
      <em>Pencil → Strudel Shell</em>
    </div>
  </div>
<div class="actions">
    <button id="clear" type="button">Clear Canvas</button>
    <button id="open-strudel" type="button" aria-label="Open Strudel in new tab">Open Strudel</button>
    <div class="preset-switch" role="group" aria-label="Strudel patch presets">
      <button class="preset" data-patch="tusic" aria-pressed="true">Default</button>
      <button class="preset" data-patch="steel-halo" aria-pressed="false">Steel Halo</button>
    </div>
    <span id="status-pill" data-state="waiting">
      <span class="dot" aria-hidden="true"></span>
      <span id="status-text">Init</span>
    </span>
  </div>
</header>

<main>
  <section id="pad" class="surface" aria-label="Pencil 捕获区域">
    <canvas id="cv"></canvas>
    <div class="hud">
      <strong>Draw • Sync • Play</strong>
      <span>Apple Pencil 的位置与压力将驱动 Strudel。</span>
      <div class="tips">
        <span>X → Rhythm</span>
        <span>Y → Pitch</span>
        <span>Pressure → Gain</span>
      </div>
    </div>
  </section>
  <section class="surface embed" aria-label="Strudel REPL">
    <iframe id="strudel" src="https://strudel.cc/?code=%2F%2F%20%3D%3D%3D%20TusicPad%20Receiver%20%3D%3D%3D%0AglobalThis.pen%20%3D%20%7B%20x%3A0.5%2C%20y%3A0.5%2C%20p%3A0.0%20%7D%3B%0Alet%20state%20%3D%20%7B%20x%3A0.5%2C%20y%3A0.5%2C%20p%3A0.0%20%7D%3B%0Aconst%20lerp%20%3D%20(a%2Cb%2Ct)%3D%3Ea%2B(b-a)*t%3B%0A%0Awindow.addEventListener('message'%2C%20(e)%3D%3E%7B%0A%20%20const%20d%20%3D%20e.data%3B%0A%20%20if(!d%20%7C%7C%20d.type!%3D%3D'pen')%20return%3B%0A%20%20pen.x%20%3D%20Math.max(0%2C%20Math.min(1%2C%20d.x))%3B%0A%20%20pen.y%20%3D%20Math.max(0%2C%20Math.min(1%2C%20d.y))%3B%0A%20%20pen.p%20%3D%20Math.max(0%2C%20Math.min(1%2C%20d.pressure%20%7C%7C%200))%3B%0A%7D)%3B%0A%0AsetInterval(()%3D%3E%7B%0A%20%20state.x%20%3D%20lerp(state.x%2C%20pen.x%2C%200.18)%3B%0A%20%20state.y%20%3D%20lerp(state.y%2C%20pen.y%2C%200.18)%3B%0A%20%20state.p%20%3D%20lerp(state.p%2C%20pen.p%2C%200.22)%3B%0A%7D%2C%2028)%3B%0A%0A%24%3A%20stack(%0A%20%20s('bd%20~%20sd%20~').gain(()%3D%3E0.45%20%2B%20state.p*0.8).speed(()%3D%3E0.9%20%2B%20state.x*0.4)%2C%0A%20%20note(()%3D%3E%20midi(48%20%2B%20Math.floor((1%20-%20state.y)*18)))%0A%20%20%20%20.sound('gm_strings')%0A%20%20%20%20.gain(()%3D%3E0.32%20%2B%20state.p*0.6)%0A%20%20%20%20.shape(()%3D%3E%20state.x)%0A%20%20%20%20.pan(()%3D%3E%20state.x*2-1)%2C%0A%20%20s('hh*4').gain(()%3D%3E0.2%20%2B%20state.p*0.5).speed(()%3D%3E1%20%2B%20state.x*0.5)%0A)%0A._pianoroll(%7Bcycles%3A4%7D)._spectrum(%7Bspeed%3A0.5%7D).gain(0.9)%0A" allow="autoplay; clipboard-read; clipboard-write" title="Strudel REPL"></iframe>
    <div class="frame-label">Strudel Repl · Default Patch Ready · Press Run</div>
  </section>

  <section class="preset-info" aria-live="polite">
    <div class="preset-meta">
      <span class="preset-title" id="preset-name">Default TusicPad Patch</span>
      <p id="preset-desc">Kick + strings + hats with Pencil mapped to rhythm / pitch / pressure.</p>
    </div>
    <div class="preset-steps" id="preset-steps">
      <span>① 在下方 Strudel 中按一次 <strong>Run ▶︎</strong> 解锁声音</span>
      <span>② 返回上方画布，用 Pencil 控制节奏 / 音高 / 质感</span>
    </div>
  </section>
</main>

<div id="gate" role="dialog" aria-modal="true">
  <div class="gate-card">
    <h2>Initiate Session</h2>
    <p>点击 Start，然后在下方 Strudel REPL 中按 Run（默认已加载 TusicPad Patch）。</p>
    <button id="open" class="primary" type="button">Start</button>
  </div>
</div>

<script>
const pad = document.getElementById('pad');
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const strudelFrame = document.getElementById('strudel');
const statusPill = document.getElementById('status-pill');
const statusText = document.getElementById('status-text');
const clearButton = document.getElementById('clear');
const openStrudelButton = document.getElementById('open-strudel');
const gate = document.getElementById('gate');
const openButton = document.getElementById('open');
const presetButtons = Array.from(document.querySelectorAll('.preset[data-patch]'));
const presetName = document.getElementById('preset-name');
const presetDesc = document.getElementById('preset-desc');

const statusCopy = {
  waiting: 'Init',
  ready: 'Ready',
  live: 'Live'
};

const dotPalette = ['#ff004f', '#ff7a00', '#ffd000'];
const reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
let fadeHandle = null;
let colorIndex = 0;
let lastSent = 0;
let settleTimer;
let currentPatch = null;

const patches = {
  'tusic': {
    id: 'tusic',
    name: 'Default TusicPad Patch',
    description: 'Kick + strings + hats with Pencil mapped to rhythm / pitch / pressure.',
    code: `// === TusicPad Receiver ===
globalThis.pen = { x:0.5, y:0.5, p:0.0 };
let state = { x:0.5, y:0.5, p:0.0 };
const lerp = (a,b,t)=>a+(b-a)*t;

window.addEventListener('message', (e)=>{
  const d = e.data;
  if(!d || d.type!=='pen') return;
  pen.x = Math.max(0, Math.min(1, d.x));
  pen.y = Math.max(0, Math.min(1, d.y));
  pen.p = Math.max(0, Math.min(1, d.pressure || 0));
});

setInterval(()=>{
  state.x = lerp(state.x, pen.x, 0.18);
  state.y = lerp(state.y, pen.y, 0.18);
  state.p = lerp(state.p, pen.p, 0.22);
}, 28);

$: stack(
  // Kick layer
  s('bd ~ sd ~').gain(()=>0.45 + state.p*0.8).speed(()=>0.9 + state.x*0.4),

  // String melody
  note(()=> midi(48 + Math.floor((1 - state.y)*18)))
    .sound('gm_strings')
    .gain(()=> 0.32 + state.p*0.6)
    .shape(()=> state.x)
    .pan(()=> state.x*2-1),

  // Hi-hats
  s('hh*4').gain(()=> state.p*0.5).hp(5000).speed(()=> 1 + state.x*0.5)
)
._pianoroll({cycles:4})._spectrum({speed:0.5}).gain(0.9)`
  },
  'steel-halo': {
    id: 'steel-halo',
    name: 'Steel Halo — Kanye × Frank',
    description: 'Industrial 909 groove, fretless bass, airy choir pad, and sparkling hats.',
    code: `// === Steel Halo: Kanye × Frank ===
// 接收 Apple Pencil 数据
globalThis.pen = {x:0.5, y:0.5, p:0.0};
let state = {x:0.5, y:0.5, p:0.0};
function lerp(a,b,t){return a+(b-a)*t;}

window.addEventListener('message', (e)=>{
  const d=e.data;
  if(!d || d.type!=='pen')return;
  pen.x=Math.max(0,Math.min(1,d.x));
  pen.y=Math.max(0,Math.min(1,d.y));
  pen.p=Math.max(0,Math.min(1,d.pressure||0));
});

setInterval(()=>{
  state.x=lerp(state.x,pen.x,0.2);
  state.y=lerp(state.y,pen.y,0.2);
  state.p=lerp(state.p,pen.p,0.2);
},30);

// === 乐曲结构 ===
$: stack(
  // 工业节奏：金属底鼓 + 断续呼吸
  s("bd*2 [~ sd] bd [~ hh] bd sd")
    .gain(()=>0.6 + state.p*0.4)
    .speed(()=>0.8 + state.x*0.4)
    .distort(()=>state.p*0.2)
    .crush(()=>2 + state.x*5),

  // 深沉贝斯：跟随笔的纵向移动
  note(()=> midi(36 + Math.floor((1-state.y)*12)))
    .sound("gm_fretless_bass")
    .gain(()=>0.4 + state.p*0.5)
    .room(0.4)
    .pan(()=>state.x*2-1),

  // Frank 风格人声垫：漂浮氛围
  note(()=> choose(["c5","d#5","g5","a#4"]))
    .sound("gm_choir_aahs")
    .gain(()=>0.3 + state.p*0.4)
    .room(0.7)
    .shape(()=>state.x)
    .slow(2)
    .cut(2),

  // 高频碎片：空气感的闪光
  s("~ hh*4 [cp*2 ~]")
    .gain(()=>0.2 + state.p*0.3)
    .hp(()=>4000 + state.x*4000)
    .speed(()=>1 + state.x*0.5)
    .pan(()=>Math.sin(performance.now()/500))
)
._pianoroll({cycles:8,playhead:0.4})
._spectrum({thickness:3,speed:0.5})
.gain(0.9)`
  }
};

function setActivePreset(patchId){
  presetButtons.forEach(btn => {
    const active = btn.dataset.patch === patchId;
    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
  });
}

function buildStrudelUrl(code){
  return `https://strudel.cc/?code=${encodeURIComponent(code)}`;
}

function loadPatch(patchId, reload = true){
  const patch = patches[patchId];
  if(!patch) return;
  const wasSame = currentPatch && currentPatch.id === patch.id;
  currentPatch = patch;
  setActivePreset(patch.id);
  presetName.textContent = patch.name;
  presetDesc.textContent = patch.description;
  const targetUrl = buildStrudelUrl(patch.code);
  if(!wasSame || reload || !strudelFrame.src.includes('strudel.cc')){
    strudelFrame.src = targetUrl;
  }
  pad.classList.remove('is-active');
  setStatus('ready');
}

function setStatus(state){
  statusPill.dataset.state = state;
  statusText.textContent = statusCopy[state] || '';
}

function resizeCanvas(){
  const rect = pad.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const width = Math.max(1, Math.floor(rect.width * dpr));
  const height = Math.max(1, Math.floor(rect.height * dpr));
  if(canvas.width !== width || canvas.height !== height){
    canvas.width = width;
    canvas.height = height;
  }
}

function clearCanvas(){
  ctx.save();
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'rgba(8,8,10,1)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.restore();
  colorIndex = 0;
}

function fadeFrame(){
  ctx.fillStyle = 'rgba(7,7,9,0.18)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  fadeHandle = requestAnimationFrame(fadeFrame);
}

function drawDot(x, y, pressure){
  const radius = (6 + pressure * 16) * (window.devicePixelRatio || 1);
  const color = dotPalette[colorIndex % dotPalette.length];
  ctx.fillStyle = color + (pressure > 0.45 ? 'dd' : 'bb');
  ctx.beginPath();
  ctx.arc(x * canvas.width, y * canvas.height, radius, 0, Math.PI * 2);
  ctx.fill();
  colorIndex += 1;
}

function sendPen(x, y, pressure){
  const target = strudelFrame.contentWindow;
  if(!target) return;
  target.postMessage({ type: 'pen', x, y, pressure, t: performance.now() }, '*');
}

function updateInteractionState(){
  pad.classList.add('is-active');
  setStatus('live');
  clearTimeout(settleTimer);
  settleTimer = setTimeout(() => {
    pad.classList.remove('is-active');
    setStatus('ready');
  }, 1100);
}

function pointerToCanvas(event){
  const rect = canvas.getBoundingClientRect();
  const x = (event.clientX - rect.left) / rect.width;
  const y = (event.clientY - rect.top) / rect.height;
  const pressure = typeof event.pressure === 'number' ? event.pressure : 0.35;
  return {
    x: Math.min(1, Math.max(0, x)),
    y: Math.min(1, Math.max(0, y)),
    pressure: Math.min(1, Math.max(0, pressure))
  };
}

pad.addEventListener('pointerdown', event => {
  if(event.pointerType !== 'pen') return;
  const data = pointerToCanvas(event);
  drawDot(data.x, data.y, data.pressure);
  sendPen(data.x, data.y, data.pressure);
  updateInteractionState();
});

pad.addEventListener('pointermove', event => {
  if(event.pointerType !== 'pen') return;
  if((event.buttons === 0) && (event.pressure === 0)) return; // hovering
  const data = pointerToCanvas(event);
  drawDot(data.x, data.y, data.pressure);
  const now = performance.now();
  if(now - lastSent > 16){
    sendPen(data.x, data.y, data.pressure);
    lastSent = now;
  }
  updateInteractionState();
}, { passive: true });

pad.addEventListener('pointerup', () => {
  clearTimeout(settleTimer);
  settleTimer = setTimeout(() => {
    pad.classList.remove('is-active');
    setStatus('ready');
  }, 620);
});

pad.addEventListener('pointerleave', () => {
  clearTimeout(settleTimer);
  pad.classList.remove('is-active');
  settleTimer = setTimeout(() => setStatus('ready'), 620);
});

clearButton.addEventListener('click', () => {
  clearCanvas();
  pad.classList.remove('is-active');
  setStatus('ready');
});

openButton.addEventListener('click', () => {
  gate.setAttribute('hidden', 'true');
  setStatus('ready');
  const target = strudelFrame.contentWindow;
  if(target){
    target.postMessage({ type: 'hint', action: 'focus' }, '*');
  }
});

if(openStrudelButton){
  openStrudelButton.addEventListener('click', () => {
    window.open(strudelFrame.src, '_blank', 'noopener,noreferrer');
  });
}

presetButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    loadPatch(btn.dataset.patch, true);
  });
});

window.addEventListener('resize', resizeCanvas, { passive: true });
window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 280));

loadPatch('tusic', false);
resizeCanvas();
clearCanvas();
if(!reduceMotion){
  fadeHandle = requestAnimationFrame(fadeFrame);
}

window.addEventListener('beforeunload', () => {
  if(fadeHandle){
    cancelAnimationFrame(fadeHandle);
  }
});

</script>
</body>
</html>
